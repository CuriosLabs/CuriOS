#!/usr/bin/env bash

# Gum driven curiOS Manager.
# Control everything related to CuriOS from here.
#
# Dependencies: gum, tte, brave, curl, curios-update, curios-dotfiles

# TODO: update ~/.zshrc alias and ~/.config/cosmic/com.system76.CosmicSettings.Shortcuts/v1/custom

#------------- Colors -------------#
readonly RED="\033[31;1m"          # Red and bold
readonly GREEN="\033[32;1m"        # Green and bold
readonly BLUE="\033[34;1m"         # Blue and bold
readonly GREY="\033[37;1m"         # Grey and bold
readonly YELLOW="\033[33;1;3m"     # Yellow, bold and italic
#readonly YELLOWBLK="\033[33;1;5m"  # Yellow, bold and slow blink
#readonly UNDL="\033[4m"            # Underlined
#readonly BOLD="\033[1m"            # Bold
readonly NC="\033[0m"              # No Color

#------------- Variables init
readonly SCRIPT_VERSION="0.2";
VERBOSE=0;
readonly CURIOS_SRC_URL="https://github.com/VideoCurio/nixos-configuration";

export GUM_CHOOSE_CURSOR_FOREGROUND="#26a269"
#export GUM_CONFIRM_SELECTED_FOREGROUND="#d0cfcc"
export GUM_CONFIRM_SELECTED_BACKGROUND="#26a269"

#------------- Print help function
usage () {
  echo -e "CuriOS Manager version ${SCRIPT_VERSION}
* modern script interface for managing your CuriOS system *

${GREY}USAGE:${NC}
  curios-manager [options]

${GREY}OPTIONS:${NC}
  ${GREY}-h, --help${NC}         Print this message.
  ${GREY}-v, --verbose${NC}      Print more information.
  ${GREY}--version${NC}          Print version number and exit."
  exit 0
}

#------------- Scripts arguments parse options
ARGS=$(getopt --longoptions="verbose,version,help" --options ":hv" --name "$0" -- "$@")
eval set -- "$ARGS"

while true; do
  case "$1" in
    -v | --verbose)
      VERBOSE=1
      shift
      ;;
    -h | --help)
      usage
      ;;
    --version)
      echo "$SCRIPT_VERSION"
      exit 0
      ;;
    --)
      shift
      break
      ;;
    *)
      break
      ;;
  esac
done

if [ $VERBOSE -eq 1 ]; then
  echo -e "Script current path: ${SCRIPT_PATH}"
fi

#precmd() { print -Pn "\e]0;CuriOS Manager" }
# Change terminal title
case $TERM in
  alacritty)
    echo -en "\e]2;CuriOS Manager\a"
    ;;
esac

#------------- Check dependencies
available() { command -v "$1" >/dev/null; }

if ! available curl; then
  echo -e "${RED}curl command not found!${NC}"
  exit 2
fi
if ! available fastfetch; then
  echo -e "${RED}fastfetch command not found!${NC}"
  exit 2
fi
if ! available gum; then
  echo -e "${RED}gum command not found!${NC}"
  exit 2
fi
if ! available tte; then
  echo -e "${RED}tte command not found!${NC}"
  exit 2
fi
# Get current OS version
if [ ! -f /etc/os-release ]; then
  echo -e "${RED}/etc/os-release file not found!${NC}"
  exit 1
fi
source /etc/os-release

#------------- Apps menu
app_menu () {
  echo -e "${RED}TBD${NC}"
}

#------------- help menu
help_menu () {
  HELP_MENU=$(gum choose --header "Open a new browser window with:" " Shortcuts" "󰄄 CuriOS" "󰄄 CuriOS - report a bug" " NixOS Wiki" " NixOS forum" " NixOS manual" " Back" )
  # open link with brave or xdg-open ?
  case $HELP_MENU in
    " Shortcuts")
      cosmic-settings keyboard 2>/dev/null
      ;;
    "󰄄 CuriOS")
      xdg-open "https://github.com/VideoCurio/nixos-configuration" 2>/dev/null
      ;;
    "󰄄 CuriOS - report a bug")
      brave --new-window --app=https://github.com/VideoCurio/nixos-configuration/issues 2>/dev/null
      ;;
    " NixOS Wiki")
      brave --new-window --app=https://wiki.nixos.org/wiki/NixOS_Wiki 2>/dev/null
      ;;
    " NixOS forum")
      brave --new-window --app=https://discourse.nixos.org/ 2>/dev/null
      ;;
    " NixOS manual")
      brave --new-window --app=https://nixos.org/manual/nixos/stable/ 2>/dev/null
      ;;
    " Back")
      main_menu
      ;;
  esac
}

#------------- system menu
system_menu () {
  SYSTEM_MENU=$(gum choose " Shutdown" " Reboot" " Lock session" " Settings (manual edit)" "󱃶 Process Management" " Info" " Back" )
  case $SYSTEM_MENU in
    " Shutdown")
      #sudo shutdown -P now
      cosmic-osd shutdown
      exit 0
      ;;
    " Reboot")
      #sudo reboot now
      cosmic-osd restart
      exit 0
      ;;
    " Lock session")
      loginctl lock-session
      ;;
    " Settings (manual edit)")
      SETTINGS_FILE="/etc/nixos/settings.nix"
      SETTINGS_LAST_MOD=$(stat -c %Y $SETTINGS_FILE)
      sudo "$EDITOR" $SETTINGS_FILE
      if [[ $(stat -c %Y $SETTINGS_FILE) -gt $SETTINGS_LAST_MOD ]]; then
        # Settings have changed, updating system.
        gum spin --spinner dot --title "Updating system..." --show-error -- sudo nixos-rebuild switch
      fi
      ;;
    "󱃶 Process Management")
      btop
      ;;
    " Info")
      fastfetch
      ;;
    " Back")
      main_menu
      ;;
  esac
}

#------------- main menu
main_menu () {
  # Startup menu choice
  MAIN_MENU=$(gum choose --header "Select an option:" " Update" " Upgrade" " System" "? Help" " About" "󰈆 Exit")
  #echo "Your choice is: $MAIN_MENU"
  case $MAIN_MENU in
    #"󰀻 Apps")
    #  app_menu
    #  ;;
    " Update")
      sudo whoami 1>/dev/null # Force prompt for sudo password now
      gum spin --spinner dot --title "Deleting oldest generations..." --show-error -- sudo nix-collect-garbage --delete-older-than 7d
      gum spin --spinner dot --title "Upgrading packages..." --show-error -- sudo nixos-rebuild switch --upgrade
      gum spin --spinner dot --title "Running store garbage collector..." --show-error -- sudo nix-store --gc
      # Check if a reboot is necessary
      LIST_GEN=$(gum spin --spinner dot --title "Retrieving NixOS information..." -- nixos-rebuild list-generations --json)
      LIST_GEN_KERNEL=$(echo "$LIST_GEN" | jq -r '.[0].kernelVersion')
      if [[ $(uname -r) != $LIST_GEN_KERNEL ]]; then
        echo -e "A new kernel was installed - ${YELLOW}You should REBOOT now${NC}."
        echo -e "${BLUE}Please${NC} ensure that all other applications are properly closed."
        gum confirm "Reboot now:" && sudo reboot now
      fi
      ;;
    " Upgrade")
      sudo curios-update --upgrade
      ;;
    " System")
      system_menu
      ;;
    "? Help")
      help_menu
      ;;
    " About")
      LIST_GEN=$(gum spin --spinner dot --title "Retrieving NixOS information..." -- nixos-rebuild list-generations --json)
      echo -e "${VARIANT} ${GREY}(${VARIANT_ID})${NC} - based on ${PRETTY_NAME}"
      LIST_GEN_DATE=$(echo "$LIST_GEN" | jq -r '.[0].date')
      LIST_GEN_KERNEL=$(echo "$LIST_GEN" | jq -r '.[0].kernelVersion')
      echo -e "Latest update: ${LIST_GEN_DATE} - Kernel: ${LIST_GEN_KERNEL}"
      echo -e "CuriOS manager version: $SCRIPT_VERSION"
      echo -e "Visit ${BLUE}${CURIOS_SRC_URL}${NC}"
      ;;
    "󰈆 Exit")
      echo -e "${GREEN}Program exited...${NC}"
      exit 0
      ;;
  esac
  main_menu # self loop
}

#------------- starting function
start () {
  clear
  if [ -f /etc/nixos/logo.txt ]; then
    tte -i /etc/nixos/logo.txt --anchor-text c --canvas-width 0 sweep --final-gradient-stops 12488B 2AA1B3 --final-gradient-steps 12 12 --final-gradient-direction diagonal
    #echo -e "${BLUE}CuriOS${NC}"
  else
    echo -e "${RED}/etc/nixos/logo.txt file is missing!${NC}";
  fi
  main_menu
}

start
