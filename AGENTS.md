# CuriOS Development Guide

This guide provides instructions and best practices for developers contributing
to the CuriOS project.

## Context

You are an expert software architect and project analysis assistant. Analyze
the current project directory and help developers that interacts with this
project. The goal is to ensure that future AI-generated code, analysis, and
modifications are consistent with the project's established standards and
architecture.

## Project Overview

- **Project Name**: CuriOS
- **Purpose**: A Linux distribution based on NixOS and the COSMIC desktop
environment, designed for modern advanced users to be productive quickly.
- **Target OS**: NixOS
- **Main Configuration Areas**: Desktop apps, networking, services.

## Core Technologies

- **Nix:** The primary language used in this project is Nix. All configurations
, packages, and the final ISO image are defined using the Nix language.
- **NixOS:** The project builds a custom version of the NixOS Linux distribution.
- **Nix Flakes:** The project uses Nix flakes (experimental feature enabled in
`configuration.nix`). Flakes provide better reproducibility and dependency
management.
- **Shell:** The project uses shell scripts for some automation tasks, such as
the ISO build script.

## Directory Structure

The project follows a modular architecture, with different aspects of the system
configuration separated into distinct Nix modules. The main directories are:

- `iso/`: Contains the files for building the bootable ISO image.
- `modules/`: The core of the project, containing the Nix modules that define
the system configuration.
  - `desktop-apps/`: Modules for installing and configuring desktop applications
  including web apps. Contains:
    - Category modules: `basics.nix`, `crypto.nix`, `devops.nix`, `gaming.nix`,
    `office.nix`, `studio.nix`
    - Web app modules: `webapp-*.nix` files that create desktop shortcuts for
    web applications (e.g., `webapp-chatgpt.nix`, `webapp-claude.nix`)
    - Desktop app modules: `desktop-*.nix` files for native desktop applications
    - Icon assets: PNG and SVG files for web app icons
  - `filesystems/`: Modules for configuring file systems, including options for
  LUKS encryption. Contains both `-v2` (newer) and legacy versions.
  - `hardened/`: Modules for applying security hardening to the system.
  - `hardware/`: Hardware-specific configurations, such as GPU drivers (AMD, NVIDIA).
  - `platforms/`: Platform-specific configurations, like for `amd64` and `rpi4`.
- `pkgs/`: Contains custom packages built for CuriOS, with each package
having its own `default.nix` file (e.g., `pkgs/curios-manager/default.nix`).
- `tests/`: Contains NixOS integration tests that run in QEMU virtual machines.
- `docs/`: Contains project documentation (architecture, getting started, etc.).
- **Module Imports**: All module imports should be done in `modules/default.nix`
not in `configuration.nix`.

## Key Files

- `configuration.nix`: The main NixOS configuration file for a CuriOS system.
  Generated by `curios-install` and should not be edited manually. User
  customizations should be done in `settings.nix`.
- `settings.nix`: A file for user-specific settings, which is imported into the
main configuration. This is where users enable/disable modules and configure
CuriOS options.
- `iso/iso-minimal.nix`: The Nix expression that defines the contents and
configuration of the bootable ISO image.
- `iso/build.sh`: Script for building the CuriOS ISO image. Handles versioning,
linting, and GitHub release uploads.
- `modules/default.nix`: The top-level module that imports all other modules in
the `modules/` directory.
- `modules/curios-options.nix`: Defines all CuriOS-specific configuration
options under `config.curios.*`.
- `curios-install`: A script for installing CuriOS to a target system.
- `tests/run-tests.sh`: Script to run all integration tests sequentially.
- `shell.nix`: A Nix configuration file for the `nix-shell` command. It will setup
a temporary environment with the specified dependencies, tools and configurations
for the bash script `curios-install` used during ISO installation.

## Coding Style and Best Practices

- **Modularity:** The project is highly modular. When adding new features,
it's important to create new modules or extend existing ones in a logical and
organized manner.
- **Descriptive Naming:** File and module names are descriptive and follow a
consistent pattern (e.g., `filesystems-luks-v2.nix`, `webapp-chatgpt.nix`).
- **Variable Naming**: Configuration options must start with `config.curios`
(e.g., `config.curios.desktop.apps.browser.chromium.enable`). All custom options
are defined in `modules/curios-options.nix`.
- **Code Style**: Use 2 spaces for indentation in Nix files.
- **Nix formatting**: Use `nixfmt` the official formatter for Nix code.
- **Comments**: The code is sparsely commented. When adding new code, add
comments only when necessary to explain complex logic.
- **Web App Modules**: Web app modules (`webapp-*.nix`) should follow the pattern
of creating a desktop entry using `makeDesktopItem` and including icon assets
(PNG and SVG formats in multiple sizes).
- **Module Structure**: When creating new modules, ensure they follow the
existing pattern: declare options, then implement configuration based on those
options using `lib.mkIf` or similar conditional logic.

## Build, Test, and Development Commands

- **Lint Nix Files**: Lint Nix files using `statix`. You can use `fd` to find
all `.nix` files:

  ```bash
  fd ".nix" . | xargs -n 1 statix check
  ```

  If you don't have `fd` installed, you can use `find`:

  ```bash
  find . -name "*.nix" -print0 | xargs -0 -n 1 statix check
  ```

- **Lint Shell Scripts**: Shell scripts must be checked with `shellcheck`:

  ```bash
  shellcheck --color=always -f tty -x ./curios-install ./iso/build.sh
  ```

- **Supported Version**: NixOS 25.11 or later. CuriOS variant version is
defined in `configuration.nix` as `nixos.variant_id` (e.g., "25.11.1").

- **Build ISO Image**: Build the CuriOS ISO using the build script:

  ```bash
  cd iso/
  ./build.sh
  ```

  The script handles versioning, linting, and can optionally upload to GitHub
  releases. ISO files are named: `CuriOS_<version>_<platform>.iso`

- **Test ISO installer**:

  ```bash
  nix-shell shell.nix
  ./curios-install
  ```

  This script is launched during an ISO installation.

- **Test Custom Packages**: Test custom Nix packages with:

  ```bash
  cd pkgs/<package-name>/
  nix-build && nix-env -i -f default.nix
  ```

- **Test NixOS Modules**: CuriOS uses the built-in NixOS test driver (`make-test-python.nix`)
to run integration tests in a virtual machine. Test files are located in the
`tests/` directory.

  To run a specific test (e.g., the office desktop apps):
  
  ```bash
  nix-build ./tests/office.nix --show-trace
  ```

  To run all tests sequentially:
  
  ```bash
  ./tests/run-tests.sh
  ```

  Test files use Python syntax with helper functions and `subtest()` context
  managers for organizing test cases. Example pattern:

  ```python
  testScript = ''
    start_all()
    machine.wait_for_unit("multi-user.target")
    
    def check_which(pkg_name: str):
        machine.succeed(f"which {pkg_name}")
    
    with subtest("check-packages"):
        check_which("package-name")
  '';
  ```

  This command will build a minimal NixOS system in a QEMU virtual machine,
  boot it, and execute the test script defined in the file.

  **Important**: Running tests will create many files in `/nix/store`. After
  you are finished with testing, run `nix-collect-garbage -d` to clean up the
  build artifacts and reclaim disk space.

- **Development Workflow**: Common development tasks:

  ```bash
  # Get latest code changes
  git log
  
  # Check current branch (important for ISO builds)
  git branch --show-current
  
  # Format Nix code (if nixfmt is installed)
  nixfmt <file.nix>
  
  # Clean up Nix store after testing
  nix-collect-garbage -d
  ```

## Configuration Examples

When working with CuriOS modules, here are common configuration patterns:

- **Enable a desktop app category**:

  ```nix
  config.curios.desktop.apps.office.enable = true;
  ```

- **Enable specific apps within a category**:

  ```nix
  config.curios.desktop.apps.browser = {
    chromium.enable = true;
    firefox.enable = true;
  };
  ```

- **Enable system services**:

  ```nix
  config.curios.services = {
    enable = true;
    printing.enable = true;
    sshd.enable = true;
  };
  ```

- **Configure hardware**:

  ```nix
  config.curios.hardware = {
    nvidiaGpu.enable = true;
    amdGpu.enable = false;
  };
  ```

## Contributing

- **Project Source**: [CuriOS GitHub](https://github.com/CuriosLabs/CuriOS)
- **Contributing Policy**: See @CONTRIBUTING.md
- **Branching Strategy**: For new features, create a branch named
`feature/<YourFeatureName>` (e.g., `git checkout -b feature/AmazingFeature`).
  - Release branches follow the pattern `release/<version>` (e.g., `release/25.11.1`)
  - Testing branches use the name `testing`
- **AI Assistance**: If using AI assistance for contributions, it must be
disclosed in pull requests (see @CONTRIBUTING.md for details).
